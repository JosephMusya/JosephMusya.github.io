<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="static/style.css">
    <link rel="icon" href="assets/images/icon.png">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""></script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyChOTRm6bv2jZKBeAIVMc2d7_peCJ5Sg94&callback=initMap"></script>
    <title>AirQ</title>
</head>

<body>
    <div class="container container-topic">
        <div class="container logo-container">
            <img class="logo" src="assets/images/AirQ.png" alt="AirQ Logo">
        </div>
    </div>
    <div class="container" id="login-container">
        <div class="card col-sm-12 col-md-4">
            <div class="mb-2 mt-2">
                <input class="form-control" type="text" placeholder="username" id="username">
            </div>
            <div class="mt-3">
                <input class="form-control" type="password" placeholder="password" id="password">
            </div>
            <button class="btn" id="login" onclick="authorize()">Log In</button>

            <p id="error-login"></p>
        </div>
    </div>
    <div class="container" id="content">
        <div id="device-list"></div>
        <div class="sensor-data"></div>
        <hr>
        <div id="map"></div>
    </div>

    <script>
        const url = 'https://api.waziup.io/api/v2';

        function displayGateway(gateway) {
            // let gateway_devices = document.createElement('div')
            // gateway_devices.setAttribute('id', 'gateways')
            let content = document.getElementById('device-list')
            for (let i = 0; i < gateway.length; i++) {
                let device = document.createElement('li')
                device.setAttribute('class', i)
                device.textContent = gateway[i].gateway_id
                content.appendChild(device)
            }
        }

        async function sensorData(sensors, device_ids) {
            // Accepts the array and key            

            sensor_data = []

            function initMap() {
                // The location of Uluru
                const dekut = {
                    lat: -0.3951,
                    lng: 36.9642
                };
                // The map, centered at Uluru
                const map = new google.maps.Map(document.getElementById("map"), {
                    zoom: 15,
                    center: dekut,
                });
                // The marker, positioned at Uluru
                const marker = new google.maps.Marker({
                    position: dekut,
                    map: map,
                });
            }

            initMap()

            // var map = L.map('map').setView([-0.3951, 36.9642], 17.0);
            // L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            //     maxZoom: 19,
            //     attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            // }).addTo(map);

            // var marker = L.marker([-0.3951, 36.9642]).addTo(map);




            // function AQI(coLevel) {
            //     const aqi = coLevel
            //     let color = 'green'
            //     if (aqi <= 100) {
            //         color = 'green'
            //     } else if ((aqi <= 180) && (aqi > 100)) {
            //         color = 'orange'
            //     } else if (aqi > 180) {
            //         color = 'red'
            //     }
            //     console.log(color)
            //     return color
            // }

            // function addToMap(airData) {
            //     const val = []
            //     for (key in airData) {
            //         val.push(airData[key])
            //     }
            //     val.forEach(datapoint => {
            //         if (datapoint.length == 2) {
            //             const co = datapoint[0].value
            //             const lat = datapoint[1].value['latitude']
            //             const lng = datapoint[1].value['longitude']
            //             console.log(lng)

            //             var circle = L.circle([lat, lng], {
            //                 color: AQI(co),
            //                 fillColor: AQI(co),
            //                 fillOpacity: 0.5,
            //                 radius: 6
            //             }).addTo(map);
            //         }
            //     })

            // }


            i = 0

            // const indexToRemove = 0
            // if (indexToRemove > -1) {
            //     sensors.splice(indexToRemove, 1);
            // }

            const groupBy = (array, key) => {
                // Return the end result
                return array.reduce((result, currentValue) => {
                    // If an array already present for key, push it to the array. Else create an array and push the object
                    (result[currentValue[key]] = result[currentValue[key]] || []).push(
                        currentValue
                    );
                    // Return the current iteration `result` value, this will be taken as next iteration `result` value and accumulate
                    return result;
                }, {}); // empty object is the initial value for result object
            };

            sensors.forEach(sensor_ => {
                sensor_.forEach(sensor => {
                    device_ids.forEach(async device => {
                        const res = await fetch(url + '/sensors_data?device_id=' + device + '&' + 'sensor_id=' + sensor.id + '&limit=1000000000')
                        let data = await res.json()
                        await data.forEach(val => {
                            sensor_data.push(val)
                        })

                        if (i == (device_ids.length * sensor_.length) - 1) {
                            const result = groupBy(sensor_data, "timestamp")
                            addToMap(result)
                        }
                        i++
                    })
                })
            })
        }

        async function getData(username) {
            const device_endpoint = '/devices'
            const sensor_data_endpoint = 'sensor_data'
            document.getElementById("login-container").hidden = true
                // document.getElementById("welcome").innerHTML = "Welcome"
            const devices = await fetch(url + device_endpoint + '?q=owner==' + username)
            const gateway = await (devices.json())

            const device_id = async(gateway) => {
                let device_ids = []
                let sensors_ = []
                for (let i = 0; i < gateway.length; i++) {
                    const id_d = gateway[i].id
                    const sensor = gateway[i].sensors
                    device_ids.push(id_d)
                    sensors_.push(sensor)
                }
                await sensorData(sensors_, device_ids)
            }

            device_id(gateway)
            displayGateway(gateway)

        }

        async function authorize() {
            const endpoint = '/auth/token'
            const username = document.getElementById('username').value
            const password = document.getElementById('password').value

            const res = await fetch(url + endpoint, {
                method: 'post',
                headers: {
                    "Content-Type": "application/json"
                },

                body: JSON.stringify({
                    'username': username,
                    'password': password
                })
            })

            const token = await res.text()
            if (res.status != 200) {
                document.getElementById('error-login').innerHTML = 'Invalid Credentials'
            } else if (res.status == '200') {
                document.getElementById('error-login').innerHTML = ''
                getData(username)

            }
            return token
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
</body>

</html>