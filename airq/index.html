<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="static/style.css">
    <link rel="icon" href="assets/images/icon.png">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""></script>

    <title>AirQ</title>
</head>

<body>
    <div class="container container-topic">
        <div class="container logo-container">
            <img class="logo" src="assets/images/AirQ.png" alt="AirQ Logo">
        </div>
    </div>
    <div class="container" id="login-container">
        <div class="card col-sm-12 col-md-4">
            <div class="mb-2 mt-2">
                <input class="form-control" type="text" placeholder="username" id="username">
            </div>
            <div class="mt-3">
                <input class="form-control" type="password" placeholder="password" id="password">
            </div>
            <button class="btn" id="login" onclick="authorize()">Log In</button>

            <p id="error-login"></p>
        </div>
    </div>
    <div class="container" id="content">
        <div id="device-list"></div>
        <div class="sensor-data"></div>
        <hr>
        <div id="map"></div>
    </div>

    <script>
        const url = 'https://api.waziup.io/api/v2';

        function displayGateway(gateway) {
            // let gateway_devices = document.createElement('div')
            // gateway_devices.setAttribute('id', 'gateways')
            let content = document.getElementById('device-list')
            for (let i = 0; i < gateway.length; i++) {
                let device = document.createElement('li')
                device.setAttribute('class', i)
                device.textContent = gateway[i].gateway_id
                content.appendChild(device)
            }
        }

        async function sensorData(sensors, device_ids) {
            // Accepts the array and key
            const groupBy = (array, key) => {
                // Return the end result
                return array.reduce((result, currentValue) => {
                    // If an array already present for key, push it to the array. Else create an array and push the object
                    (result[currentValue[key]] = result[currentValue[key]] || []).push(
                        currentValue
                    );
                    // Return the current iteration `result` value, this will be taken as next iteration `result` value and accumulate
                    return result;
                }, {}); // empty object is the initial value for result object
            };

            sensor_data = []
            var map = L.map('map').setView([-0.429, 36.930], 15.0);
            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);

            var marker = L.marker([-0.429, 36.930]).addTo(map);

            function addToMap(airData) {
                var circle = L.circle([-0.429, 36.950], {
                    color: 'green',
                    fillColor: 'green',
                    fillOpacity: 0.5,
                    radius: 20
                }).addTo(map);
                var circle = L.circle([-0.42998, 36.9578], {
                    color: 'green',
                    fillColor: 'green',
                    fillOpacity: 0.5,
                    radius: 20
                }).addTo(map);

                var circle = L.circle([-0.429781, 36.95211], {
                    color: 'green',
                    fillColor: 'green',
                    fillOpacity: 0.5,
                    radius: 20
                }).addTo(map);

                var circle = L.circle([-0.429900, 36.95099], {
                    color: 'green',
                    fillColor: 'green',
                    fillOpacity: 0.5,
                    radius: 20
                }).addTo(map);

                var circle = L.circle([-0.42999911, 36.9590676], {
                    color: 'green',
                    fillColor: 'green',
                    fillOpacity: 0.5,
                    radius: 20
                }).addTo(map);

                var circle = L.circle([-0.4296811, 36.9500998], {
                    color: 'green',
                    fillColor: 'green',
                    fillOpacity: 0.5,
                    radius: 20
                }).addTo(map);

                var circle = L.circle([-0.42909922, 36.9501234], {
                    color: 'green',
                    fillColor: 'green',
                    fillOpacity: 0.5,
                    radius: 20
                }).addTo(map);


                var circle = L.circle([-0.426, 36.940], {
                    color: 'green',
                    fillColor: 'green',
                    fillOpacity: 0.5,
                    radius: 20
                }).addTo(map);
                var circle = L.circle([-0.46998, 36.92568], {
                    color: 'green',
                    fillColor: 'green',
                    fillOpacity: 0.5,
                    radius: 20
                }).addTo(map);

                var circle = L.circle([-0.4259781, 36.955211], {
                    color: 'green',
                    fillColor: 'green',
                    fillOpacity: 0.5,
                    radius: 20
                }).addTo(map);

                var circle = L.circle([-0.42789900, 36.9512099], {
                    color: 'green',
                    fillColor: 'green',
                    fillOpacity: 0.5,
                    radius: 20
                }).addTo(map);

                var circle = L.circle([-0.4210999911, 36.922590676], {
                    color: 'green',
                    fillColor: 'green',
                    fillOpacity: 0.5,
                    radius: 20
                }).addTo(map);

                var circle = L.circle([-0.44286811, 36.99000998], {
                    color: 'green',
                    fillColor: 'green',
                    fillOpacity: 0.5,
                    radius: 20
                }).addTo(map);

                var circle = L.circle([-0.4298909922, 36.94301234], {
                    color: 'green',
                    fillColor: 'green',
                    fillOpacity: 0.5,
                    radius: 20
                }).addTo(map);

                var popup = L.popup()
                    .setLatLng([-0.429, 36.930])
                    .setContent("Gateway 1")
                    // .closeButton(true)
                    .openOn(map);
            }


            i = 0

            const indexToRemove = 0
            if (indexToRemove > -1) {
                sensors.splice(indexToRemove, 1);
            }

            sensors.forEach(sensor_ => {
                sensor_.forEach(sensor => {
                    device_ids.forEach(async device => {
                        const res = await fetch(url + '/sensors_data?device_id=' + device + '&' + 'sensor_id=' + sensor.id)
                        let data = await res.json()
                        await data.forEach(val => {
                            sensor_data.push(val)
                        })


                        if (i == (device_ids.length * sensor_.length) - 1) {
                            const result = groupBy(sensor_data, "timestamp")
                            addToMap(result)
                        }

                        i++
                    })
                })
            })
        }

        async function getData(username) {
            const device_endpoint = '/devices'
            const sensor_data_endpoint = 'sensor_data'
            document.getElementById("login-container").hidden = true
                // document.getElementById("welcome").innerHTML = "Welcome"
            const devices = await fetch(url + device_endpoint + '?q=owner==' + username)
            const gateway = await (devices.json())

            const device_id = async(gateway) => {
                let device_ids = []
                let sensors_ = []
                for (let i = 0; i < gateway.length; i++) {
                    const id_d = gateway[i].id
                    const sensor = gateway[i].sensors
                    device_ids.push(id_d)
                    sensors_.push(sensor)
                }
                await sensorData(sensors_, device_ids)
            }

            device_id(gateway)
            displayGateway(gateway)

        }

        async function authorize() {
            const endpoint = '/auth/token'
            const username = document.getElementById('username').value
            const password = document.getElementById('password').value

            const res = await fetch(url + endpoint, {
                method: 'post',
                headers: {
                    "Content-Type": "application/json"
                },

                body: JSON.stringify({
                    'username': username,
                    'password': password
                })
            })

            const token = await res.text()
            if (res.status != 200) {
                document.getElementById('error-login').innerHTML = 'Invalid Credentials'
            } else if (res.status == '200') {
                document.getElementById('error-login').innerHTML = ''
                getData(username)

            }
            return token
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
</body>

</html>